<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Feature Engineering - DataLab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        }
        .upload-area:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
        }
        .result-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        .loading-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
        }
        .progress-step {
            padding: 10px 0;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        .progress-step.active {
            opacity: 1;
            color: #667eea;
            font-weight: bold;
        }
        .progress-step.completed {
            opacity: 1;
            color: #28a745;
        }
        .importance-chart {
            max-height: 400px;
            overflow-y: auto;
        }
        .feature-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.85em;
        }
        .comparison-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .best-result {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .datalab-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 10px 0;
        }
        .datalab-nav {
            background: #34495e;
        }
        .nav-link {
            color: #ecf0f1 !important;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            color: #3498db !important;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 5px;
        }
    </style>
</head>
<body class="bg-light">
    
    <!-- DataLab Header -->
    <div class="datalab-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0">
                        <i class="fas fa-flask me-2"></i>DataLab
                        <small class="text-muted ms-2">| Advanced Feature Engineering</small>
                    </h4>
                </div>
                <div class="col-md-6 text-end">
                    <a href="/" class="btn btn-outline-light btn-sm me-2">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                    <a href="/logout" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="datalab-nav">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex flex-wrap">
                        <a href="/data" class="nav-link px-3 py-2">
                            <i class="fas fa-database me-1"></i>Data Management
                        </a>
                        <a href="/preprocessing" class="nav-link px-3 py-2">
                            <i class="fas fa-cogs me-1"></i>Preprocessing
                        </a>
                        <a href="/visualization" class="nav-link px-3 py-2">
                            <i class="fas fa-chart-bar me-1"></i>Visualization
                        </a>
                        <a href="/ml" class="nav-link px-3 py-2">
                            <i class="fas fa-brain me-1"></i>Machine Learning
                        </a>
                        <a href="/module6" class="nav-link px-3 py-2 active" style="background: rgba(52, 152, 219, 0.2);">
                            <i class="fas fa-magic me-1"></i>Feature Engineering
                        </a>
                        <a href="/ai" class="nav-link px-3 py-2">
                            <i class="fas fa-robot me-1"></i>AI Assistant
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Analyzing Your Data...</h5>
            <p class="text-muted mb-4">Running comprehensive feature engineering analysis</p>
            
            <div id="progressSteps">
                <div class="progress-step" id="step1">üìä Analyzing feature importance</div>
                <div class="progress-step" id="step2">üéØ Creating intelligent features</div>
                <div class="progress-step" id="step3">üìà Reducing dimensionality</div>
                <div class="progress-step" id="step4">‚öñÔ∏è Comparing feature sets</div>
                <div class="progress-step" id="step5">üè≠ Getting domain suggestions</div>
                <div class="progress-step" id="step6">ü§ñ Generating AI insights</div>
                <div class="progress-step" id="step7">üß† Making intelligent decisions</div>
                <div class="progress-step" id="step8">üîß Creating optimized dataset</div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="gradient-bg text-white py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-robot me-3"></i>Automated Feature Engineering
                    </h1>
                    <p class="lead mb-0">
                        Simply upload your dataset and let AI automatically discover, create, and optimize features for your machine learning models.
                    </p>
                </div>
                <div class="col-md-4 text-center">
                    <i class="fas fa-magic fa-5x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        
        <!-- Dataset Selection Section -->
        <div class="row justify-content-center" id="uploadSection">
            <div class="col-md-10">
                <!-- Dataset Selection Tabs -->
                <div class="card mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="datasetTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="existing-tab" data-bs-toggle="tab" data-bs-target="#existing-dataset" type="button" role="tab">
                                    <i class="fas fa-database me-2"></i>Select Existing Dataset
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-dataset" type="button" role="tab">
                                    <i class="fas fa-upload me-2"></i>Upload New Dataset
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="datasetTabsContent">
                            <!-- Existing Dataset Tab -->
                            <div class="tab-pane fade show active" id="existing-dataset" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label for="datasetSelect" class="form-label">
                                            <i class="fas fa-list me-2"></i>Select Dataset from DataLab
                                        </label>
                                        <select class="form-select form-select-lg" id="datasetSelect">
                                            <option value="">Choose a dataset...</option>
                                        </select>
                                        <div class="form-text" id="datasetInfo"></div>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button class="btn btn-success btn-lg w-100" id="loadDatasetBtn" disabled>
                                            <i class="fas fa-play me-2"></i>Load & Analyze
                                        </button>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3" id="noDatasetsAlert" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No datasets found. Please upload a dataset first or switch to the upload tab.
                                </div>
                            </div>

                            <!-- Upload Dataset Tab -->
                            <div class="tab-pane fade" id="upload-dataset" role="tabpanel">
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                                    <h4>Drop your dataset here or click to browse</h4>
                                    <p class="text-muted mb-4">Supports CSV and Excel files ‚Ä¢ Max size: 100MB</p>
                                    <input type="file" id="fileInput" accept=".csv,.xlsx" style="display: none;">
                                    <button class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open me-2"></i>Choose File
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <div class="row">
                        <div class="col-md-4">
                            <i class="fas fa-database fa-2x text-primary mb-2"></i>
                            <h6>1. Select Dataset</h6>
                            <small class="text-muted">Choose from existing datasets or upload new</small>
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-cogs fa-2x text-success mb-2"></i>
                            <h6>2. AI Analysis</h6>
                            <small class="text-muted">Automatic feature engineering</small>
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                            <h6>3. Get Results</h6>
                            <small class="text-muted">Review insights & recommendations</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            
            <!-- Dataset Overview -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-database fa-2x text-primary me-3"></i>
                    <div>
                        <h4 class="mb-0">Dataset Overview</h4>
                        <small class="text-muted">Basic information about your data</small>
                    </div>
                </div>
                <div id="datasetOverview"></div>
            </div>

            <!-- Feature Importance -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-star fa-2x text-warning me-3"></i>
                    <div>
                        <h4 class="mb-0">Most Important Features</h4>
                        <small class="text-muted">Features ranked by multiple AI methods</small>
                    </div>
                </div>
                <div id="featureImportanceResults"></div>
            </div>

            <!-- Created Features -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-plus-circle fa-2x text-success me-3"></i>
                    <div>
                        <h4 class="mb-0">Intelligent Features Created</h4>
                        <small class="text-muted">New features automatically generated from your data</small>
                    </div>
                </div>
                <div id="createdFeaturesResults"></div>
            </div>

            <!-- Best Feature Sets -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-trophy fa-2x text-primary me-3"></i>
                    <div>
                        <h4 class="mb-0">Best Feature Combinations</h4>
                        <small class="text-muted">Optimal feature sets ranked by performance</small>
                    </div>
                </div>
                <div id="comparisonResults"></div>
            </div>

            <!-- Dimensionality Insights -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-compress fa-2x text-info me-3"></i>
                    <div>
                        <h4 class="mb-0">Dimensionality Analysis</h4>
                        <small class="text-muted">How much information can be preserved with fewer features</small>
                    </div>
                </div>
                <div id="dimensionalityResults"></div>
            </div>

            <!-- AI Insights -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-robot fa-2x text-success me-3"></i>
                    <div>
                        <h4 class="mb-0">ü§ñ AI-Powered Insights</h4>
                        <small class="text-muted">GPT-3.5-turbo analysis of your data and features</small>
                    </div>
                </div>
                <div id="aiInsightsResults"></div>
            </div>

            <!-- Intelligent Decisions -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-brain fa-2x text-info me-3"></i>
                    <div>
                        <h4 class="mb-0">üß† Intelligent Decisions</h4>
                        <small class="text-muted">LLM-driven decisions about what techniques to apply</small>
                    </div>
                </div>
                <div id="intelligentDecisionsResults"></div>
            </div>

            <!-- Optimized Dataset -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-database fa-2x text-primary me-3"></i>
                    <div>
                        <h4 class="mb-0">üîß Optimized Dataset</h4>
                        <small class="text-muted">End-to-end processed dataset ready for ML</small>
                    </div>
                </div>
                <div id="optimizedDatasetResults"></div>
            </div>

            <!-- Recommendations -->
            <div class="result-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-lightbulb fa-2x text-warning me-3"></i>
                    <div>
                        <h4 class="mb-0">Strategic Recommendations</h4>
                        <small class="text-muted">Comprehensive action plan for your ML project</small>
                    </div>
                </div>
                <div id="recommendationsResults"></div>
            </div>

            <!-- Export Options -->
            <div class="result-card text-center">
                <h5 class="mb-3"><i class="fas fa-download me-2"></i>Export Results</h5>
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" onclick="exportResults('json')">
                            <i class="fas fa-file-code me-2"></i>JSON Report
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="exportResults('csv')">
                            <i class="fas fa-file-csv me-2"></i>Feature Importance
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100" onclick="exportResults('features')">
                            <i class="fas fa-list me-2"></i>Created Features
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100" onclick="startOver()">
                            <i class="fas fa-redo me-2"></i>Analyze New Dataset
                        </button>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Footer -->
    <footer class="gradient-bg text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 DataLab - Automated Feature Engineering Module</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Safe toFixed helper to handle null/undefined values
        function safeToFixed(value, decimals) {
            if (value === null || value === undefined || isNaN(value)) {
                return 'N/A';
            }
            return parseFloat(value).toFixed(decimals);
        }

        let analysisResults = null;
        let availableDatasets = [];

        // Dataset selection elements
        const datasetSelect = document.getElementById('datasetSelect');
        const loadDatasetBtn = document.getElementById('loadDatasetBtn');
        const datasetInfo = document.getElementById('datasetInfo');
        const noDatasetsAlert = document.getElementById('noDatasetsAlert');

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Dataset selection handling
        datasetSelect.addEventListener('change', handleDatasetSelection);
        loadDatasetBtn.addEventListener('click', handleLoadDataset);

        // Load available datasets on page load
        async function loadAvailableDatasets() {
            try {
                const response = await fetch('/module6/available_datasets');
                if (!response.ok) {
                    throw new Error('Failed to load datasets');
                }

                const data = await response.json();
                availableDatasets = data.datasets;

                // Populate dropdown
                datasetSelect.innerHTML = '<option value="">Choose a dataset...</option>';

                if (availableDatasets.length === 0) {
                    noDatasetsAlert.style.display = 'block';
                    loadDatasetBtn.disabled = true;
                    return;
                }

                noDatasetsAlert.style.display = 'none';

                availableDatasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.id;
                    option.textContent = `${dataset.name} (${dataset.rows} rows √ó ${dataset.columns} cols)`;
                    datasetSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading datasets:', error);
                showErrorMessage('Failed to load available datasets. Please refresh the page.');
                noDatasetsAlert.style.display = 'block';
                loadDatasetBtn.disabled = true;
            }
        }

        function handleDatasetSelection() {
            const selectedId = datasetSelect.value;
            const selectedDataset = availableDatasets.find(ds => ds.id == selectedId);

            if (selectedDataset) {
                datasetInfo.innerHTML = `
                    <strong>${selectedDataset.name}</strong><br>
                    <small class="text-muted">
                        ${selectedDataset.rows} rows √ó ${selectedDataset.columns} columns ‚Ä¢
                        Format: ${selectedDataset.file_type.toUpperCase()}
                    </small>
                `;
                loadDatasetBtn.disabled = false;
            } else {
                datasetInfo.innerHTML = '';
                loadDatasetBtn.disabled = true;
            }
        }

        async function handleLoadDataset() {
            const selectedId = datasetSelect.value;
            if (!selectedId) {
                showErrorMessage('Please select a dataset first.');
                return;
            }

            // Show loading
            showLoading();

            try {
                // Step 1: Load the dataset
                updateProgress(1, 'active');

                const loadResponse = await fetch(`/module6/load_dataset/${selectedId}`, {
                    method: 'POST'
                });

                if (!loadResponse.ok) {
                    const errorData = await loadResponse.json();
                    throw new Error(errorData.error || 'Failed to load dataset');
                }

                const loadResult = await loadResponse.json();
                updateProgress(1, 'completed');

                // Show dataset info
                displayDatasetOverview(loadResult);

                // Step 2: Run complete analysis
                updateProgress(2, 'active');
                await new Promise(resolve => setTimeout(resolve, 500));

                const analysisResponse = await fetch('/module6/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!analysisResponse.ok) {
                    const errorText = await analysisResponse.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || 'Analysis failed';
                    } catch {
                        errorMessage = `Analysis failed: ${analysisResponse.status} ${analysisResponse.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const analysisResult = await analysisResponse.json();

                // Update progress through all steps
                for (let i = 2; i <= 8; i++) {
                    updateProgress(i, 'active');
                    await new Promise(resolve => setTimeout(resolve, 400));
                    updateProgress(i, 'completed');
                }

                // Store results and display
                analysisResults = analysisResult.results;
                displayResults(analysisResults);

                // Hide loading and show results
                hideLoading();
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';

            } catch (error) {
                hideLoading();
                showErrorMessage(error.message);
            }
        }

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading
            showLoading();
            
            try {
                // Step 1: Upload file
                updateProgress(1, 'active');
                
                const uploadResponse = await fetch('/module6/upload', {
                    method: 'POST',
                    body: formData
                }).catch(error => {
                    throw new Error('Cannot connect to server. Please ensure the DataLab app is running.');
                });
                
                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || 'Upload failed';
                    } catch {
                        errorMessage = `Upload failed: ${uploadResponse.status} ${uploadResponse.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const uploadResult = await uploadResponse.json();
                updateProgress(1, 'completed');
                
                // Show dataset info
                displayDatasetOverview(uploadResult);
                
                // Step 2: Run complete analysis
                updateProgress(2, 'active');
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay for UX
                
                const analysisResponse = await fetch('/module6/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).catch(error => {
                    throw new Error('Cannot connect to server for analysis. Please check the DataLab app.');
                });
                
                if (!analysisResponse.ok) {
                    const errorText = await analysisResponse.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || 'Analysis failed';
                    } catch {
                        errorMessage = `Analysis failed: ${analysisResponse.status} ${analysisResponse.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const analysisResult = await analysisResponse.json();
                
                // Update progress through all steps
                for (let i = 2; i <= 8; i++) {
                    updateProgress(i, 'active');
                    await new Promise(resolve => setTimeout(resolve, 400));
                    updateProgress(i, 'completed');
                }
                
                // Store results and display
                analysisResults = analysisResult.results;
                displayResults(analysisResults);
                
                // Hide loading and show results
                hideLoading();
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                
            } catch (error) {
                hideLoading();
                showErrorMessage(error.message);
            }
        }

        function showErrorMessage(message) {
            const errorHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Insert error message at the top of the upload section
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.insertAdjacentHTML('afterbegin', errorHtml);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                const alert = uploadSection.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 10000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            // Reset progress
            for (let i = 1; i <= 8; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateProgress(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.classList.remove('active', 'completed');
            step.classList.add(status);
        }

        function displayDatasetOverview(uploadResult) {
            const overview = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h5 class="text-primary">${uploadResult.shape[0]}</h5>
                            <small>Rows</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h5 class="text-primary">${uploadResult.shape[1]}</h5>
                            <small>Columns</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <strong>Target Column:</strong> <span class="badge bg-success">${uploadResult.detected_target}</span>
                            <br><small class="text-muted">Automatically detected</small>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('datasetOverview').innerHTML = overview;
        }

        function displayResults(results) {
            displayFeatureImportance(results.feature_importance);
            displayCreatedFeatures(results.created_features);
            displayComparison(results.feature_comparison);
            displayDimensionality(results.dimensionality_reduction);
            displayAIInsights(results.llm_insights);
            displayIntelligentDecisions(results.llm_insights);
            displayOptimizedDataset(results.optimized_dataset);
            displayRecommendations(results);
        }

        function displayFeatureImportance(importance) {
            if (importance.error) {
                document.getElementById('featureImportanceResults').innerHTML = 
                    `<div class="alert alert-warning">Error: ${importance.error}</div>`;
                return;
            }

            let html = '<div class="row">';
            
            Object.entries(importance).forEach(([method, scores]) => {
                if (Array.isArray(scores)) {
                    html += `
                        <div class="col-md-6 mb-3">
                            <h6 class="text-capitalize">${method.replace('_', ' ')}</h6>
                            <div class="importance-chart">
                    `;
                    
                    scores.slice(0, 8).forEach(([feature, score]) => {
                        const percentage = Math.round(score * 100);
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-truncate me-2" style="max-width: 150px;">${feature}</span>
                                <div class="flex-grow-1 mx-2">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                                <small class="text-muted">${safeToFixed(score, 3)}</small>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
            });
            
            html += '</div>';
            document.getElementById('featureImportanceResults').innerHTML = html;
        }

        function displayCreatedFeatures(features) {
            if (features.error) {
                document.getElementById('createdFeaturesResults').innerHTML = 
                    `<div class="alert alert-warning">Error: ${features.error}</div>`;
                return;
            }

            const featureCount = Object.keys(features).length;
            let html = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Successfully created <strong>${featureCount}</strong> intelligent features
                </div>
                <div class="mt-3">
            `;
            
            Object.keys(features).forEach(feature => {
                html += `<span class="feature-badge">${feature}</span>`;
            });
            
            html += '</div>';
            document.getElementById('createdFeaturesResults').innerHTML = html;
        }

        function displayComparison(comparison) {
            if (comparison.error) {
                document.getElementById('comparisonResults').innerHTML = 
                    `<div class="alert alert-warning">Error: ${comparison.error}</div>`;
                return;
            }

            // Sort results by performance
            const sortedResults = Object.entries(comparison).sort(([,a], [,b]) => {
                if (a.error || b.error) return 0;
                if (a.metric === 'mse') {
                    return a.mean_score - b.mean_score; // Lower MSE is better
                } else {
                    return b.mean_score - a.mean_score; // Higher accuracy is better
                }
            });

            let html = '';
            
            sortedResults.forEach(([setName, result], index) => {
                if (result.error) return;
                
                const isTopResult = index === 0;
                const cardClass = isTopResult ? 'best-result' : 'bg-light';
                const textClass = isTopResult ? 'text-white' : '';
                
                html += `
                    <div class="${cardClass} p-3 mb-2 rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 ${textClass}">
                                    ${setName.replace(/_/g, ' ').toUpperCase()}
                                    ${isTopResult ? '<i class="fas fa-crown ms-2"></i>' : ''}
                                </h6>
                                <small class="${isTopResult ? 'text-white-50' : 'text-muted'}">
                                    ${result.n_features} features
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="h5 mb-0 ${textClass}">
                                    ${safeToFixed(result.mean_score, 4)}
                                </div>
                                <small class="${isTopResult ? 'text-white-50' : 'text-muted'}">
                                    ${result.metric.toUpperCase()}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('comparisonResults').innerHTML = html;
        }

        function displayDimensionality(dimensionality) {
            if (dimensionality.error) {
                document.getElementById('dimensionalityResults').innerHTML = 
                    `<div class="alert alert-warning">Error: ${dimensionality.error}</div>`;
                return;
            }

            let html = '<div class="row">';
            
            if (dimensionality.pca) {
                const variance = dimensionality.pca.explained_variance_ratio;
                const cumulative = dimensionality.pca.cumulative_variance;
                
                html += `
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line me-2"></i>PCA Analysis</h6>
                        <p class="text-muted">First 2 components explain <strong>${safeToFixed(cumulative[1] * 100, 1)}%</strong> of variance</p>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-info" style="width: ${variance[0] * 100}%"></div>
                            <div class="progress-bar bg-warning" style="width: ${variance[1] * 100}%"></div>
                        </div>
                        <small class="text-muted">Component 1: ${safeToFixed(variance[0] * 100, 1)}% | Component 2: ${safeToFixed(variance[1] * 100, 1)}%</small>
                    </div>
                `;
            }
            
            if (dimensionality.tsne) {
                html += `
                    <div class="col-md-6">
                        <h6><i class="fas fa-project-diagram me-2"></i>t-SNE Analysis</h6>
                        <p class="text-muted">Non-linear projection completed successfully</p>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>
                            t-SNE preserves local structure and reveals hidden patterns in your data
                            </small>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('dimensionalityResults').innerHTML = html;
        }

        function displayAIInsights(llmInsights) {
            if (!llmInsights || llmInsights.error) {
                document.getElementById('aiInsightsResults').innerHTML = 
                    `<div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AI analysis unavailable: ${llmInsights?.error || 'Please set OPENAI_API_KEY in .env file'}
                     </div>`;
                return;
            }

            let html = '';
            
            // Dataset Analysis
            if (llmInsights.dataset_analysis) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary"><i class="fas fa-database me-2"></i>Dataset Analysis</h6>
                        <div class="bg-light p-3 rounded">
                            <div class="markdown-content">${formatMarkdown(llmInsights.dataset_analysis)}</div>
                        </div>
                    </div>
                `;
            }

            // Feature Importance Analysis
            if (llmInsights.importance_analysis) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-warning"><i class="fas fa-star me-2"></i>Feature Importance Insights</h6>
                        <div class="bg-light p-3 rounded">
                            <div class="markdown-content">${formatMarkdown(llmInsights.importance_analysis)}</div>
                        </div>
                    </div>
                `;
            }

            // Domain Suggestions
            if (llmInsights.domain_suggestions) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-success"><i class="fas fa-industry me-2"></i>Domain-Specific Suggestions</h6>
                        <div class="bg-light p-3 rounded">
                            <div class="markdown-content">${formatMarkdown(llmInsights.domain_suggestions)}</div>
                        </div>
                    </div>
                `;
            }

            // Performance Explanation
            if (llmInsights.performance_explanation) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-info"><i class="fas fa-chart-line me-2"></i>Performance Analysis</h6>
                        <div class="bg-light p-3 rounded">
                            <div class="markdown-content">${formatMarkdown(llmInsights.performance_explanation)}</div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('aiInsightsResults').innerHTML = html;
        }

        function displayIntelligentDecisions(llmInsights) {
            if (!llmInsights || llmInsights.error || !llmInsights.intelligent_decisions) {
                document.getElementById('intelligentDecisionsResults').innerHTML = 
                    `<div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Intelligent decisions unavailable
                     </div>`;
                return;
            }

            const decisions = llmInsights.intelligent_decisions;
            if (decisions.error) {
                document.getElementById('intelligentDecisionsResults').innerHTML = 
                    `<div class="alert alert-danger">Error: ${decisions.error}</div>`;
                return;
            }

            let html = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-brain me-2"></i>
                    <strong>Confidence Score:</strong> ${safeToFixed(decisions.confidence_score * 100, 1)}%
                </div>
                <div class="row">
            `;

            // Feature Scaling Decision
            if (decisions.apply_feature_scaling) {
                const scaling = decisions.apply_feature_scaling;
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card ${scaling.decision ? 'border-success' : 'border-secondary'}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-balance-scale me-2"></i>Feature Scaling
                                    <span class="badge ${scaling.decision ? 'bg-success' : 'bg-secondary'}">${scaling.decision ? 'YES' : 'NO'}</span>
                                </h6>
                                <p class="card-text small">${scaling.reason}</p>
                                ${scaling.method && scaling.method !== 'none' ? `<span class="badge bg-info">${scaling.method}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Dimensionality Reduction Decision
            if (decisions.apply_dimensionality_reduction) {
                const dimRed = decisions.apply_dimensionality_reduction;
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card ${dimRed.decision ? 'border-success' : 'border-secondary'}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-compress me-2"></i>Dimensionality Reduction
                                    <span class="badge ${dimRed.decision ? 'bg-success' : 'bg-secondary'}">${dimRed.decision ? 'YES' : 'NO'}</span>
                                </h6>
                                <p class="card-text small">${dimRed.reason}</p>
                                ${dimRed.method && dimRed.method !== 'none' ? `<span class="badge bg-info">${dimRed.method} (${dimRed.n_components} components)</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Outlier Removal Decision
            if (decisions.apply_outlier_removal) {
                const outlier = decisions.apply_outlier_removal;
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card ${outlier.decision ? 'border-success' : 'border-secondary'}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-filter me-2"></i>Outlier Removal
                                    <span class="badge ${outlier.decision ? 'bg-success' : 'bg-secondary'}">${outlier.decision ? 'YES' : 'NO'}</span>
                                </h6>
                                <p class="card-text small">${outlier.reason}</p>
                                ${outlier.method && outlier.method !== 'none' ? `<span class="badge bg-info">${outlier.method}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            // Recommended Features
            if (decisions.recommended_features) {
                const recFeatures = decisions.recommended_features;
                html += `
                    <div class="mt-4">
                        <h6><i class="fas fa-star me-2"></i>Recommended Feature Set: <span class="text-primary">${recFeatures.feature_set}</span></h6>
                        <p class="small text-muted">${recFeatures.reasoning}</p>
                        <div class="d-flex flex-wrap gap-1">
                            ${recFeatures.features.map(f => `<span class="badge bg-primary">${f}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Next Actions
            if (decisions.next_actions && decisions.next_actions.length > 0) {
                html += `
                    <div class="mt-4">
                        <h6><i class="fas fa-tasks me-2"></i>Next Actions</h6>
                        <ul class="list-group list-group-flush">
                            ${decisions.next_actions.map(action => `<li class="list-group-item">${action}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            document.getElementById('intelligentDecisionsResults').innerHTML = html;
        }

        function displayOptimizedDataset(optimizedResult) {
            if (!optimizedResult || optimizedResult.error) {
                document.getElementById('optimizedDatasetResults').innerHTML = 
                    `<div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Optimized dataset unavailable: ${optimizedResult?.error || 'No optimization performed'}
                     </div>`;
                return;
            }

            let html = `
                <div class="alert alert-success mb-3">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>${optimizedResult.improvement_summary}</strong>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h5 class="text-success">${optimizedResult.final_shape[0]}</h5>
                            <small>Final Rows</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h5 class="text-success">${optimizedResult.final_shape[1]}</h5>
                            <small>Final Features</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <button class="btn btn-success btn-sm" onclick="downloadOptimizedDataset()">
                                <i class="fas fa-download me-1"></i>Download CSV
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6><i class="fas fa-list me-2"></i>Processing Log</h6>
                    <div class="bg-light p-3 rounded">
                        ${optimizedResult.processing_log.map(log => `<div class="small">${log}</div>`).join('')}
                    </div>
                </div>
            `;

            document.getElementById('optimizedDatasetResults').innerHTML = html;
        }

        function formatMarkdown(text) {
            // Simple markdown formatting
            return text
                .replace(/### (.*)/g, '<h5>$1</h5>')
                .replace(/## (.*)/g, '<h4>$1</h4>')
                .replace(/# (.*)/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/- (.*)/g, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        async function downloadOptimizedDataset() {
            if (!analysisResults || !analysisResults.optimized_dataset || !analysisResults.optimized_dataset.optimized_dataset) {
                alert('No optimized dataset available for download');
                return;
            }

            try {
                showLoading();
                const response = await fetch('/module6/download/optimized_dataset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis_results: analysisResults
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Download failed');
                }

                // Create download link
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'optimized_dataset.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                hideLoading();
            } catch (error) {
                hideLoading();
                alert('Error downloading optimized dataset: ' + error.message);
            }
        }

        function displayRecommendations(results) {
            // Use LLM-generated comprehensive recommendations if available
            if (results.llm_insights && results.llm_insights.comprehensive_recommendations && !results.llm_insights.error) {
                const recommendations = results.llm_insights.comprehensive_recommendations;
                
                document.getElementById('recommendationsResults').innerHTML = `
                    <div class="bg-gradient p-4 rounded text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h6 class="mb-3"><i class="fas fa-robot me-2"></i>AI-Generated Strategic Recommendations</h6>
                        <div class="bg-white bg-opacity-20 p-3 rounded">
                            <pre style="white-space: pre-wrap; font-family: inherit; color: white; margin: 0;">${recommendations}</pre>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Fallback to rule-based recommendations
            let recommendations = [];
            
            // Analyze results and generate recommendations
            if (results.feature_importance && !results.feature_importance.error) {
                recommendations.push({
                    icon: 'fas fa-star',
                    title: 'Feature Selection',
                    text: 'Focus on the top-ranked features from multiple methods for better model performance.'
                });
            }
            
            if (results.created_features && !results.created_features.error) {
                const createdCount = Object.keys(results.created_features).length;
                recommendations.push({
                    icon: 'fas fa-plus-circle',
                    title: 'Feature Engineering',
                    text: `${createdCount} new features were created. Test these in your models to potentially improve performance.`
                });
            }
            
            if (results.feature_comparison && !results.feature_comparison.error) {
                recommendations.push({
                    icon: 'fas fa-trophy',
                    title: 'Model Performance',
                    text: 'Use the best-performing feature set as your starting point for model training.'
                });
            }
            
            if (results.dimensionality_reduction && results.dimensionality_reduction.pca && !results.dimensionality_reduction.error) {
                const variance = results.dimensionality_reduction.pca.cumulative_variance;
                if (variance && variance.length > 1 && variance[1] > 0.8) {
                    recommendations.push({
                        icon: 'fas fa-compress',
                        title: 'Dimensionality Reduction',
                        text: 'You can reduce to 2 components and still keep 80%+ of the information. Consider PCA for faster training.'
                    });
                }
            }
            
            // Default recommendations
            recommendations.push({
                icon: 'fas fa-chart-line',
                title: 'Next Steps',
                text: 'Use these insights to train your machine learning models with optimized features.'
            });
            
            let html = '<div class="alert alert-info mb-3"><i class="fas fa-info-circle me-2"></i>Basic recommendations (AI analysis unavailable)</div>';
            recommendations.forEach(rec => {
                html += `
                    <div class="d-flex align-items-start mb-3">
                        <div class="me-3">
                            <i class="${rec.icon} fa-lg text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">${rec.title}</h6>
                            <p class="text-muted mb-0">${rec.text}</p>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('recommendationsResults').innerHTML = html;
        }

        async function exportResults(format) {
            if (!analysisResults) {
                alert('No results to export');
                return;
            }

            try {
                showLoading();
                let endpoint, filename;

                if (format === 'json') {
                    endpoint = '/module6/download/analysis_results';
                    filename = 'feature_engineering_analysis.json';
                } else if (format === 'csv') {
                    endpoint = '/module6/download/feature_importance';
                    filename = 'feature_importance.csv';
                } else if (format === 'features') {
                    endpoint = '/module6/download/feature_list';
                    filename = 'created_features.csv';
                } else {
                    throw new Error('Unsupported export format');
                }

                const response = await fetch(endpoint);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Export failed');
                }

                // Create download link
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                hideLoading();
            } catch (error) {
                hideLoading();
                alert('Error exporting results: ' + error.message);
            }
        }

        function startOver() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
            analysisResults = null;
        }

        async function checkServerConnection() {
            try {
                const response = await fetch('/module6/health');
                if (response.ok) {
                    console.log('‚úÖ Module 6 server connection successful');
                } else {
                    throw new Error('Server responded with error');
                }
            } catch (error) {
                showErrorMessage('Cannot connect to the Module 6 server. Please ensure the DataLab application is running.');
                console.error('‚ùå Module 6 server connection failed:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkServerConnection();
            loadAvailableDatasets();
        });
    </script>
</body>
</html>

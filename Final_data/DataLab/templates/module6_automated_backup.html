<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Feature Selection - DataLab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; }
        body { background: var(--light); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 40px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header h1 { font-weight: 700; font-size: 2.5rem; }
        .card { border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; border-radius: 16px; background: white; }
        .card-body { padding: 30px; }
        .btn-primary { background: var(--primary); border: none; padding: 14px 32px; font-weight: 600; border-radius: 8px; transition: all 0.3s; }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37,99,235,0.3); }
        .btn-success { background: var(--success); border: none; padding: 14px 32px; font-weight: 600; border-radius: 8px; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16,185,129,0.3); }
        .method-badge { display: inline-block; padding: 8px 16px; border-radius: 6px; margin: 5px; font-size: 0.85em; font-weight: 600; }
        .method-badge.best { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        .method-badge.good { background: #dbeafe; color: #1e40af; }
        .metric-card { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-left: 4px solid var(--primary); padding: 24px; margin: 10px 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .metric-label { font-size: 0.85rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .metric-value { font-size: 2.5rem; font-weight: 700; color: var(--dark); font-family: 'SF Mono', 'Monaco', monospace; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 9999; backdrop-filter: blur(4px); }
        .loading-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 50px; border-radius: 20px; text-align: center; min-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .spinner { border: 6px solid #e2e8f0; border-top: 6px solid var(--primary); border-radius: 50%; width: 70px; height: 70px; animation: spin 0.8s linear infinite; margin: 0 auto 24px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-step { padding: 12px 16px; margin: 8px 0; border-radius: 8px; background: #f1f5f9; font-size: 0.9rem; transition: all 0.3s; }
        .progress-step.active { background: #dbeafe; border-left: 4px solid var(--primary); font-weight: 600; }
        .progress-step.complete { background: #d1fae5; border-left: 4px solid var(--success); }
        .log-viewer { max-height: 500px; overflow-y: auto; background: #0f172a; color: #e2e8f0; padding: 20px; border-radius: 12px; font-family: 'SF Mono', 'Monaco', 'Courier New', monospace; font-size: 0.85em; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3); }
        .log-line { margin: 3px 0; line-height: 1.6; }
        .cv-section { background: #f8fafc; padding: 24px; border-radius: 12px; margin: 20px 0; border: 1px solid #e2e8f0; }
        .cv-iteration { background: white; padding: 16px; margin: 12px 0; border-radius: 8px; border-left: 3px solid var(--primary); }
        .fold-scores { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
        .fold-score { padding: 6px 12px; background: #f1f5f9; border-radius: 6px; font-family: 'SF Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--dark); }
        .feature-list { max-height: 400px; overflow-y: auto; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .feature-item { display: inline-block; background: white; padding: 8px 16px; margin: 6px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 0.9em; font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .stat-box .label { font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .stat-box .value { font-size: 1.8rem; font-weight: 700; color: var(--primary); margin: 8px 0; font-family: 'SF Mono', monospace; }
        .professional-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .professional-table thead th { background: #f1f5f9; padding: 16px; text-align: left; font-weight: 600; color: var(--dark); border-bottom: 2px solid #cbd5e1; }
        .professional-table tbody td { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; }
        .professional-table tbody tr { cursor: pointer; transition: all 0.2s; }
        .professional-table tbody tr:hover { background: #f8fafc; }
        .professional-table tbody tr.selected { background: #dbeafe !important; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-robot"></i> Automated Feature Selection</h1>
            <p class="mb-0">20-Fold CV | Professional ML Pipeline | User-Controlled Export</p>
        </div>
    </div>

    <div class="container mt-4">
        <div class="card">
            <div class="card-body">
                <h3><i class="fas fa-database"></i> Step 1: Load Your Dataset</h3>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Upload CSV File</label>
                        <input type="file" id="fileInput" accept=".csv" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Or Select Existing Dataset</label>
                        <select id="datasetSelector" class="form-select">
                            <option value="">-- Select dataset --</option>
                        </select>
                    </div>
                </div>
                <div id="datasetInfo" class="mt-3" style="display:none;">
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> Dataset Loaded</h5>
                        <p class="mb-1"><strong>Name:</strong> <span id="datasetName"></span></p>
                        <p class="mb-1"><strong>Shape:</strong> <span id="datasetShape"></span></p>
                        <p class="mb-0"><strong>Target Column:</strong> <span id="datasetTarget"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h3><i class="fas fa-magic"></i> Step 2: Run Automated Feature Selection</h3>
                <div class="alert alert-info">
                    <p class="mb-2"><strong>20-Fold Cross-Validation</strong> on 6 methods:</p>
                    <ul class="mb-0">
                        <li>Forward Selection | Backward Elimination | Feature Importance</li>
                        <li>Correlation Analysis | Variance Threshold | Statistical Tests</li>
                    </ul>
                </div>
                <button id="runBtn" class="btn btn-primary btn-lg w-100" onclick="runAutomation()" disabled>
                    <i class="fas fa-play-circle"></i> Run Automated Feature Selection (20-Fold CV)
                </button>
            </div>
        </div>

        <div id="results" class="card" style="display:none;">
            <div class="card-body">
                <h3><i class="fas fa-trophy"></i> Results & Recommendation</h3>
                <div id="resultsContent"></div>
                
                <div class="mt-4">
                    <h4><i class="fas fa-hand-pointer"></i> Select Method to Export</h4>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> <strong>Click any row</strong> in the table above to select which method's features to export
                    </div>
                    <div id="exportOptions"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <h4 id="loadingTitle">Running 20-Fold Cross-Validation</h4>
            <p id="loadingMsg">This may take 2-3 minutes...</p>
            <div id="progressSteps" class="mt-3 text-start"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDataset = null;
        let allMethodsData = {};
        let selectedMethod = null;
        let selectedFeatures = [];

        fetch('/module6/available_datasets')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('datasetSelector');
                data.datasets.forEach(ds => {
                    const opt = document.createElement('option');
                    opt.value = ds.id;
                    opt.textContent = `${ds.name} (${ds.rows}x${ds.columns})`;
                    select.appendChild(opt);
                });
            });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            showLoading('Uploading file...', []);
            fetch('/module6/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.error) alert('Error: ' + data.error);
                    else showDatasetInfo(data);
                });
        });

        document.getElementById('datasetSelector').addEventListener('change', function() {
            const id = this.value;
            if (!id) return;
            showLoading('Loading dataset...', []);
            fetch(`/module6/load_dataset/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.error) alert('Error: ' + data.error);
                    else showDatasetInfo(data);
                });
        });

        function showDatasetInfo(data) {
            currentDataset = data;
            document.getElementById('datasetName').textContent = data.dataset_info ? data.dataset_info.name : 'Uploaded File';
            document.getElementById('datasetShape').textContent = `${data.shape[0]} rows x ${data.shape[1]} columns`;
            document.getElementById('datasetTarget').textContent = data.detected_target;
            document.getElementById('datasetInfo').style.display = 'block';
            document.getElementById('runBtn').disabled = false;
        }

        function runAutomation() {
            if (!currentDataset) {
                alert('Please load a dataset first');
                return;
            }

            const steps = ['[1/6] Forward Selection', '[2/6] Backward Elimination', '[3/6] Feature Importance', '[4/6] Correlation Analysis', '[5/6] Variance Threshold', '[6/6] Statistical Tests', 'Calculating Best Method...'];
            showLoading('Running 20-fold CV on all methods...', steps);
            
            let currentStep = 0;
            const progressInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    updateProgress(currentStep);
                    currentStep++;
                }
            }, 10000);

            fetch('/module6/run_automated', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                clearInterval(progressInterval);
                hideLoading();
                if (data.error) alert('Error: ' + data.error);
                else displayResults(data.recommendation);
            })
            .catch(err => {
                clearInterval(progressInterval);
                hideLoading();
                alert('Error: ' + err.message);
            });
        }

        function displayResults(recommendation) {
            const best = recommendation.best_method_details;
            const allResults = recommendation.all_results;
            const scoringDetails = recommendation.scoring_details || [];
            const detailedLogs = recommendation.detailed_logs || [];
            
            allMethodsData = allResults;

            let html = `
                <div class="alert alert-success">
                    <h4><i class="fas fa-star"></i> Optimal Method: ${best.method}</h4>
                    <p>${best.description}</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="label">CV Score (${best.cv_folds}-Fold)</div>
                        <div class="value">${best.score ? best.score.toFixed(4) : 'N/A'}</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Features Selected</div>
                        <div class="value">${best.n_features}/${recommendation.original_features}</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Composite Score</div>
                        <div class="value">${best.composite_score.toFixed(4)}</div>
                    </div>
                </div>

                <h5 class="mt-4"><i class="fas fa-table"></i> All Methods - Click to Select</h5>
                <table class="professional-table">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Features</th>
                            <th>CV Score</th>
                            <th>Composite</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scoringDetails.forEach((detail, idx) => {
                const isBest = detail.method === recommendation.best_method;
                html += `
                    <tr onclick="selectMethod('${detail.method}')" id="row_${detail.method}" ${isBest ? 'class="selected"' : ''}>
                        <td><strong>${detail.method.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></td>
                        <td><span style="font-family: 'SF Mono', monospace;">${detail.n_features}/${recommendation.original_features}</span></td>
                        <td><span style="font-family: 'SF Mono', monospace; font-weight: 600;">${detail.cv_score !== 'N/A' ? detail.cv_score.toFixed(4) : 'â€”'}</span></td>
                        <td><strong style="font-family: 'SF Mono', monospace; color: var(--primary);">${detail.composite_score.toFixed(4)}</strong></td>
                        <td>${isBest ? '<span class="method-badge best"><i class="fas fa-crown"></i> OPTIMAL</span>' : `<span class="method-badge good">#${idx + 1}</span>`}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            document.getElementById('resultsContent').innerHTML = html;
            document.getElementById('results').style.display = 'block';
            selectMethod(recommendation.best_method);
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function selectMethod(methodName) {
            selectedMethod = methodName;
            const methodData = allMethodsData[methodName];
            
            if (!methodData || methodData.error) {
                alert('This method has no valid results');
                return;
            }
            
            selectedFeatures = methodData.selected_features;
            
            document.querySelectorAll('.professional-table tbody tr').forEach(row => {
                row.classList.remove('selected');
            });
            const selectedRow = document.getElementById(`row_${methodName}`);
            if (selectedRow) selectedRow.classList.add('selected');
            
            const exportHtml = `
                <div class="card" style="background: #ecfdf5; border: 2px solid var(--success);">
                    <div class="card-body">
                        <h5><i class="fas fa-check-circle text-success"></i> Selected: ${methodData.method}</h5>
                        <p class="mb-3"><strong>${methodData.n_features} features</strong> ready to export</p>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success btn-lg w-100" onclick="exportToDashboard()">
                                    <i class="fas fa-upload"></i> Export to Dashboard
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-primary btn-lg w-100" onclick="downloadNotebook()">
                                    <i class="fas fa-file-code"></i> Download Notebook
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('exportOptions').innerHTML = exportHtml;
        }

        function exportToDashboard() {
            if (!selectedFeatures.length || !selectedMethod) {
                alert('Please select a method first');
                return;
            }

            showLoading('Exporting to dashboard...', []);
            fetch('/module6/export_to_dashboard', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    selected_features: selectedFeatures,
                    method_name: selectedMethod
                })
            })
            .then(r => r.json())
            .then(data => {
                hideLoading();
                if (data.error) alert('Error: ' + data.error);
                else alert(`Success! "${data.dataset_name}" with ${data.features_count} features added to dashboard.`);
            })
            .catch(err => {
                hideLoading();
                alert('Error: ' + err.message);
            });
        }

        function downloadNotebook() {
            if (!selectedFeatures.length || !selectedMethod) {
                alert('Please select a method first');
                return;
            }

            showLoading('Generating notebook...', []);
            fetch('/module6/generate_notebook', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    method_name: selectedMethod,
                    selected_features: selectedFeatures
                })
            })
            .then(r => r.json())
            .then(data => {
                hideLoading();
                if (data.error) alert('Error: ' + data.error);
                else {
                    const blob = new Blob([JSON.stringify(data.notebook, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            })
            .catch(err => {
                hideLoading();
                alert('Error: ' + err.message);
            });
        }

        function updateProgress(stepIndex) {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, i) => {
                if (i < stepIndex) {
                    step.classList.remove('active');
                    step.classList.add('complete');
                } else if (i === stepIndex) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active', 'complete');
                }
            });
        }

        function showLoading(msg, steps) {
            document.getElementById('loadingMsg').textContent = msg;
            const stepsDiv = document.getElementById('progressSteps');
            stepsDiv.innerHTML = steps.map(s => `<div class="progress-step">${s}</div>`).join('');
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>

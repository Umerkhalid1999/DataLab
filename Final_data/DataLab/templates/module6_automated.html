<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Feature Selection - DataLab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; }
        body { background: var(--light); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 40px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header h1 { font-weight: 700; font-size: 2.5rem; }
        .card { border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; border-radius: 16px; background: white; }
        .card-body { padding: 30px; }
        .btn-primary { background: var(--primary); border: none; padding: 14px 32px; font-weight: 600; border-radius: 8px; transition: all 0.3s; }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37,99,235,0.3); }
        .btn-success { background: var(--success); border: none; padding: 14px 32px; font-weight: 600; border-radius: 8px; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16,185,129,0.3); }
        .method-badge { display: inline-block; padding: 8px 16px; border-radius: 6px; margin: 5px; font-size: 0.85em; font-weight: 600; }
        .method-badge.best { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        .method-badge.good { background: #dbeafe; color: #1e40af; }
        .metric-card { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-left: 4px solid var(--primary); padding: 24px; margin: 10px 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .metric-label { font-size: 0.85rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .metric-value { font-size: 2.5rem; font-weight: 700; color: var(--dark); font-family: 'SF Mono', 'Monaco', monospace; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 9999; backdrop-filter: blur(8px); }
        .loading-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 20px; text-align: center; min-width: 700px; max-width: 90vw; box-shadow: 0 20px 60px rgba(0,0,0,0.4); max-height: 90vh; overflow-y: auto; }
        .fold-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; }
        .fold-box { aspect-ratio: 1; border: 2px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; transition: all 0.3s; background: #f8fafc; }
        .fold-box.active { background: #fef3c7; border-color: #f59e0b; animation: pulse 1s infinite; }
        .fold-box.complete { background: #d1fae5; border-color: #10b981; color: #065f46; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .progress-bar-custom { height: 30px; background: #e2e8f0; border-radius: 15px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .current-status { background: #dbeafe; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid var(--primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-step { padding: 12px 16px; margin: 8px 0; border-radius: 8px; background: #f1f5f9; font-size: 0.9rem; transition: all 0.3s; }
        .progress-step.active { background: #dbeafe; border-left: 4px solid var(--primary); font-weight: 600; }
        .progress-step.complete { background: #d1fae5; border-left: 4px solid var(--success); }
        .log-viewer { max-height: 500px; overflow-y: auto; background: #0f172a; color: #e2e8f0; padding: 20px; border-radius: 12px; font-family: 'SF Mono', 'Monaco', 'Courier New', monospace; font-size: 0.85em; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3); }
        .log-line { margin: 3px 0; line-height: 1.6; }
        .transparency-section { background: #f8fafc; padding: 30px; border-radius: 12px; margin: 25px 0; border: 2px solid #cbd5e1; }
        .validation-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 25px; border-radius: 12px; margin: 20px 0; border-left: 5px solid var(--primary); }
        .cv-iteration { background: white; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .fold-scores { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; }
        .fold-score { padding: 10px 8px; background: #f1f5f9; border-radius: 6px; font-family: 'SF Mono', monospace; font-size: 0.8rem; font-weight: 600; color: var(--dark); text-align: center; border: 1px solid #cbd5e1; }
        .fold-score.high { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .fold-score.low { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .iteration-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .iteration-title { font-weight: 700; font-size: 1.1rem; color: var(--dark); }
        .iteration-stats { display: flex; gap: 20px; }
        .iteration-stat { text-align: center; }
        .iteration-stat .label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        .iteration-stat .value { font-size: 1.3rem; font-weight: 700; font-family: 'SF Mono', monospace; color: var(--primary); }
        .feature-list { max-height: 400px; overflow-y: auto; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .feature-item { display: inline-block; background: white; padding: 8px 16px; margin: 6px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 0.9em; font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .stat-box .label { font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .stat-box .value { font-size: 1.8rem; font-weight: 700; color: var(--primary); margin: 8px 0; font-family: 'SF Mono', monospace; }
        .professional-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .professional-table thead th { background: #f1f5f9; padding: 16px; text-align: left; font-weight: 600; color: var(--dark); border-bottom: 2px solid #cbd5e1; }
        .professional-table tbody td { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; }
        .professional-table tbody tr { cursor: pointer; transition: all 0.2s; }
        .professional-table tbody tr:hover { background: #f8fafc; }
        .professional-table tbody tr.selected { background: #dbeafe !important; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-robot"></i> Automated Feature Selection</h1>
                    <p class="mb-0">5-Fold CV | Professional ML Pipeline | Explainable AI</p>
                </div>
                <div>
                    <a href="/dashboard" class="btn btn-light btn-lg" style="padding: 12px 30px; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="card">
            <div class="card-body">
                <h3><i class="fas fa-database"></i> Step 1: Load Your Dataset</h3>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Upload CSV File</label>
                        <input type="file" id="fileInput" accept=".csv" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Or Select Existing Dataset</label>
                        <select id="datasetSelector" class="form-select">
                            <option value="">-- Select dataset --</option>
                        </select>
                    </div>
                </div>
                <div id="datasetInfo" class="mt-3" style="display:none;">
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> Dataset Loaded</h5>
                        <p class="mb-1"><strong>Name:</strong> <span id="datasetName"></span></p>
                        <p class="mb-1"><strong>Shape:</strong> <span id="datasetShape"></span></p>
                        <p class="mb-0"><strong>Target Column:</strong> <span id="datasetTarget"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h3><i class="fas fa-magic"></i> Step 2: Run Automated Feature Selection</h3>
                <div class="alert alert-info">
                    <p class="mb-2"><strong>5-Fold Cross-Validation</strong> on 3 transparent methods:</p>
                    <ul class="mb-0">
                        <li><strong>Forward Selection:</strong> Iteratively adds best features</li>
                        <li><strong>Backward Elimination:</strong> Iteratively removes worst features</li>
                        <li><strong>Stepwise Selection:</strong> Combines forward + backward approaches</li>
                    </ul>
                </div>
                <button id="runBtn" class="btn btn-primary btn-lg w-100" onclick="runAutomation()" disabled>
                    <i class="fas fa-play-circle"></i> Run Automated Feature Selection (5-Fold CV)
                </button>
            </div>
        </div>

        <div id="results" class="card" style="display:none;">
            <div class="card-body">
                <h3><i class="fas fa-trophy"></i> Results & Recommendation</h3>
                <div id="resultsContent"></div>
                
                <div class="mt-4">
                    <h4><i class="fas fa-hand-pointer"></i> Select Method to Export</h4>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> <strong>Click any row</strong> in the table above to select which method's features to export
                    </div>
                    <div id="exportOptions"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-content">
            <h4 id="loadingTitle">ðŸ”¬ Running 5-Fold Cross-Validation</h4>
            <p id="loadingMsg" style="color: #64748b; margin-bottom: 20px;">Validating features on held-out data...</p>
            
            <div class="current-status" id="currentStatus">
                <strong>Current Method:</strong> <span id="currentMethod">Initializing...</span>
            </div>
            
            <div class="progress-bar-custom">
                <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
            </div>
            
            <div id="progressSteps" class="mt-3 text-start"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDataset = null;
        let allMethodsData = {};
        let selectedMethod = null;
        let selectedFeatures = [];

        fetch('/module6/available_datasets')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('datasetSelector');
                data.datasets.forEach(ds => {
                    const opt = document.createElement('option');
                    opt.value = ds.id;
                    opt.textContent = `${ds.name} (${ds.rows}x${ds.columns})`;
                    select.appendChild(opt);
                });
            });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            showLoading('Uploading file...', []);
            fetch('/module6/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.error) alert('Error: ' + data.error);
                    else showDatasetInfo(data);
                });
        });

        document.getElementById('datasetSelector').addEventListener('change', function() {
            const id = this.value;
            if (!id) return;
            showLoading('Loading dataset...', []);
            fetch(`/module6/load_dataset/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.error) alert('Error: ' + data.error);
                    else showDatasetInfo(data);
                });
        });

        function showDatasetInfo(data) {
            currentDataset = data;
            document.getElementById('datasetName').textContent = data.dataset_info ? data.dataset_info.name : 'Uploaded File';
            document.getElementById('datasetShape').textContent = `${data.shape[0]} rows x ${data.shape[1]} columns`;
            document.getElementById('datasetTarget').textContent = data.detected_target;
            document.getElementById('datasetInfo').style.display = 'block';
            document.getElementById('runBtn').disabled = false;
        }

        function runAutomation() {
            if (!currentDataset) {
                alert('Please load a dataset first');
                return;
            }

            const steps = ['[1/3] Forward Selection', '[2/3] Backward Elimination', '[3/3] Stepwise Selection'];
            showLoading('Validating features on held-out data...', steps);
            
            let currentStep = 0;
            const totalSteps = 3;
            const progressInterval = setInterval(() => {
                if (currentStep < totalSteps) {
                    document.getElementById('currentMethod').textContent = steps[currentStep];
                    updateLoadingProgress(currentStep, totalSteps);
                    currentStep++;
                }
            }, 20000);

            fetch('/module6/run_automated', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                clearInterval(progressInterval);
                // Show 100% completion
                updateLoadingProgress(totalSteps - 1, totalSteps);
                setTimeout(() => {
                    hideLoading();
                    if (data.error) alert('Error: ' + data.error);
                    else displayResults(data.recommendation);
                }, 500);
            })
            .catch(err => {
                clearInterval(progressInterval);
                hideLoading();
                alert('Error: ' + err.message);
            });
        }

        function displayResults(recommendation) {
            const best = recommendation.best_method_details;
            const allResults = recommendation.all_results;
            const scoringDetails = recommendation.scoring_details || [];
            const detailedLogs = recommendation.detailed_logs || [];
            
            allMethodsData = allResults;

            let html = `
                <div class="validation-card">
                    <h4><i class="fas fa-shield-alt"></i> Validation Strategy</h4>
                    <p><strong>5-Fold Cross-Validation:</strong> Each feature set is validated on 5 different held-out data splits to ensure robustness and prevent overfitting.</p>
                    <ul style="margin: 10px 0; line-height: 1.8;">
                        <li><strong>Held-out Testing:</strong> Each fold uses 80% training, 20% testing - features never see test data during selection</li>
                        <li><strong>Generalization Check:</strong> Low standard deviation (Ïƒ) across folds indicates stable performance on unseen data</li>
                        <li><strong>Overfitting Prevention:</strong> Features validated on 5 independent splits - high variance = overfitting detected</li>
                    </ul>
                </div>

                <div class="alert alert-success">
                    <h4><i class="fas fa-star"></i> Optimal Method: ${best.method}</h4>
                    <p>${best.description}</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="label">CV Score (${best.cv_folds}-Fold)</div>
                        <div class="value">${best.score ? best.score.toFixed(4) : 'N/A'}</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Features Selected</div>
                        <div class="value">${best.n_features}/${recommendation.original_features}</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Composite Score</div>
                        <div class="value">${best.composite_score.toFixed(4)}</div>
                    </div>
                </div>

                <h5 class="mt-4"><i class="fas fa-table"></i> All Methods - Click to Select</h5>
                <table class="professional-table">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Features</th>
                            <th>CV Score</th>
                            <th>Composite</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scoringDetails.forEach((detail, idx) => {
                const isBest = detail.method === recommendation.best_method;
                html += `
                    <tr onclick="selectMethod('${detail.method}')" id="row_${detail.method}" ${isBest ? 'class="selected"' : ''}>
                        <td><strong>${detail.method.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></td>
                        <td><span style="font-family: 'SF Mono', monospace;">${detail.n_features}/${recommendation.original_features}</span></td>
                        <td><span style="font-family: 'SF Mono', monospace; font-weight: 600;">${detail.cv_score !== 'N/A' ? detail.cv_score.toFixed(4) : 'â€”'}</span></td>
                        <td><strong style="font-family: 'SF Mono', monospace; color: var(--primary);">${detail.composite_score.toFixed(4)}</strong></td>
                        <td>${isBest ? '<span class="method-badge best"><i class="fas fa-crown"></i> OPTIMAL</span>' : `<span class="method-badge good">#${idx + 1}</span>`}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            
            html += `
                <div class="transparency-section mt-4">
                    <h4><i class="fas fa-calculator"></i> Scoring Methodology - How We Rank Methods</h4>
                    <p style="color: #64748b; margin-bottom: 20px;">Composite Score = Performance (50%) + Reduction (30%) + Reliability (20%)</p>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="validation-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left-color: #f59e0b;">
                                <h5><i class="fas fa-chart-line"></i> Performance (50%)</h5>
                                <p style="font-family: 'SF Mono', monospace; font-size: 0.9rem; background: white; padding: 10px; border-radius: 6px; margin: 10px 0;">
                                    Score = |CV_Score| Ã— 0.5
                                </p>
                                <p style="font-size: 0.85rem;">Higher CV score from 5-fold validation = better model accuracy. Absolute value handles negative metrics (MSE).</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="validation-card" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left-color: #3b82f6;">
                                <h5><i class="fas fa-compress-alt"></i> Reduction (30%)</h5>
                                <p style="font-family: 'SF Mono', monospace; font-size: 0.9rem; background: white; padding: 10px; border-radius: 6px; margin: 10px 0;">
                                    Score = (1 - |ratio - 0.4|) Ã— 0.3<br>
                                    ratio = n_selected / n_total
                                </p>
                                <p style="font-size: 0.85rem;">Ideal: 40% of features. Penalizes too many (overfitting) or too few (underfitting) features.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="validation-card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left-color: #10b981;">
                                <h5><i class="fas fa-shield-check"></i> Reliability (20%)</h5>
                                <p style="font-family: 'SF Mono', monospace; font-size: 0.9rem; background: white; padding: 10px; border-radius: 6px; margin: 10px 0;">
                                    Forward: 0.90<br>
                                    Backward: 0.90<br>
                                    Stepwise: 0.95
                                </p>
                                <p style="font-size: 0.85rem;">Based on literature: Stepwise highest (combines both approaches), wrapper methods proven effective.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert" style="background: #f8fafc; border-left: 4px solid #64748b; margin-top: 20px;">
                        <h6><strong>Example Calculation for Forward Selection:</strong></h6>
                        <p style="font-family: 'SF Mono', monospace; font-size: 0.9rem; margin: 10px 0;">
                            CV Score = 0.7502, Features = 4/8 (50%)<br>
                            Performance = 0.7502 Ã— 0.5 = <strong>0.3751</strong><br>
                            Reduction = (1 - |0.5 - 0.4|) Ã— 0.3 = (1 - 0.1) Ã— 0.3 = <strong>0.2700</strong><br>
                            Reliability = 0.90 Ã— 0.2 = <strong>0.1800</strong><br>
                            <strong>Composite = 0.3751 + 0.2700 + 0.1800 = 0.8251</strong>
                        </p>
                    </div>
                </div>
            `;

            // Add Explainable AI Section with Key Points
            if (recommendation.explanations) {
                html += `
                    <div class="transparency-section mt-4" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 3px solid #f59e0b;">
                        <h3 style="color: #92400e; margin-bottom: 20px;">
                            <i class="fas fa-lightbulb"></i> Understanding Your Results - Key Points
                        </h3>
                        <p style="font-size: 1.1rem; color: #78350f; margin-bottom: 25px;">
                            <strong>What just happened?</strong> Here's a simple explanation of all the decisions made during your analysis:
                        </p>
                `;

                // Display CV Folds explanation
                if (recommendation.explanations.cv_folds) {
                    html += `
                        <div class="card mb-3" style="border-left: 4px solid #3b82f6;">
                            <div class="card-body">
                                <h5><i class="fas fa-sync-alt"></i> Why 5-Fold Cross-Validation?</h5>
                                <div class="alert alert-info" style="background: #dbeafe; border: none;">
                                    <strong>Key Points:</strong>
                                    <ul style="margin-top: 10px; line-height: 1.8;">
                                        <li><strong>Industry Standard:</strong> 5-fold is what professionals use - perfect balance of speed and reliability</li>
                                        <li><strong>Testing Method:</strong> Your model is tested 5 times on different data splits</li>
                                        <li><strong>Each Test:</strong> Uses 80% for training, 20% for testing</li>
                                        <li><strong>Final Score:</strong> Average of all 5 tests = more reliable than single test</li>
                                        <li><strong>Why Not More?</strong> 10-fold would be slower with minimal accuracy gain</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Display sampling explanation
                if (recommendation.explanations.sampling_decision) {
                    html += `
                        <div class="card mb-3" style="border-left: 4px solid #10b981;">
                            <div class="card-body">
                                <h5><i class="fas fa-database"></i> Data Sampling Decision</h5>
                                <div class="alert alert-success" style="background: #d1fae5; border: none;">
                                    <strong>Key Points:</strong>
                                    <ul style="margin-top: 10px; line-height: 1.8;">
                                        <li><strong>Your Dataset Size:</strong> Analyzed to determine if sampling needed</li>
                                        <li><strong>Why It Matters:</strong> Large datasets can take hours - sampling gives 95%+ accuracy in minutes</li>
                                        <li><strong>No Data Loss:</strong> Final model can still use ALL your data</li>
                                        <li><strong>Professional Practice:</strong> Google, Facebook, and research papers all use sampling</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Display PCA explanation
                if (recommendation.explanations.pca_vs_tsne) {
                    html += `
                        <div class="card mb-3" style="border-left: 4px solid #8b5cf6;">
                            <div class="card-body">
                                <h5><i class="fas fa-compress-arrows-alt"></i> Why PCA (Not t-SNE)?</h5>
                                <div class="alert alert-warning" style="background: #fef3c7; border: none;">
                                    <strong>Key Points:</strong>
                                    <ul style="margin-top: 10px; line-height: 1.8;">
                                        <li><strong>Speed:</strong> PCA is 30-100x faster than t-SNE</li>
                                        <li><strong>Reproducibility:</strong> PCA gives same results every time (t-SNE doesn't)</li>
                                        <li><strong>Works with New Data:</strong> PCA can transform future data (t-SNE can't)</li>
                                        <li><strong>Interpretable:</strong> You can see how original features contribute</li>
                                        <li><strong>ML Compatible:</strong> Required for building deployable models</li>
                                        <li><strong>When t-SNE?</strong> Only for visualization in presentations, not for models</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Add Key Takeaways
                html += `
                    <div class="card" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 3px solid #6366f1;">
                        <div class="card-body">
                            <h4 style="color: #3730a3;"><i class="fas fa-check-circle"></i> Key Takeaways - What You Should Know</h4>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6 style="color: #4338ca;"><strong>What Happened:</strong></h6>
                                    <ul style="line-height: 1.8;">
                                        <li>Tested <strong>${recommendation.original_features} features</strong> from your dataset</li>
                                        <li>Used <strong>3 different methods</strong> to find best features</li>
                                        <li>Each method tested with <strong>5-fold cross-validation</strong></li>
                                        <li>Best method selected: <strong>${best.method}</strong></li>
                                        <li>Reduced to <strong>${best.n_features} important features</strong></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 style="color: #4338ca;"><strong>What This Means:</strong></h6>
                                    <ul style="line-height: 1.8;">
                                        <li><strong>Better Performance:</strong> Fewer, more important features = better predictions</li>
                                        <li><strong>Faster Training:</strong> Smaller dataset trains models quicker</li>
                                        <li><strong>Less Overfitting:</strong> Removing noise improves generalization</li>
                                        <li><strong>Easier Understanding:</strong> Focus on what really matters</li>
                                        <li><strong>Production Ready:</strong> Validated and tested thoroughly</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert" style="background: white; margin-top: 20px; border: 2px solid #6366f1;">
                                <h6 style="color: #3730a3;"><i class="fas fa-arrow-right"></i> <strong>Next Steps:</strong></h6>
                                <p style="margin-bottom: 10px;">1. <strong>Review the method comparison table</strong> above to see all options</p>
                                <p style="margin-bottom: 10px;">2. <strong>Click on any method</strong> to see detailed iteration logs</p>
                                <p style="margin-bottom: 10px;">3. <strong>Download the selected features</strong> as CSV for your model</p>
                                <p style="margin-bottom: 0;">4. <strong>Use the notebook</strong> to reproduce this analysis anytime</p>
                            </div>
                        </div>
                    </div>
                `;

                html += `</div>`;
            }

            document.getElementById('resultsContent').innerHTML = html;
            document.getElementById('results').style.display = 'block';
            selectMethod(recommendation.best_method);
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function selectMethod(methodName) {
            selectedMethod = methodName;
            const methodData = allMethodsData[methodName];
            
            if (!methodData || methodData.error) {
                alert('This method has no valid results');
                return;
            }
            
            selectedFeatures = methodData.selected_features;
            
            document.querySelectorAll('.professional-table tbody tr').forEach(row => {
                row.classList.remove('selected');
            });
            const selectedRow = document.getElementById(`row_${methodName}`);
            if (selectedRow) selectedRow.classList.add('selected');
            
            let exportHtml = `
                <div class="card" style="background: #ecfdf5; border: 2px solid var(--success);">
                    <div class="card-body">
                        <h5><i class="fas fa-check-circle text-success"></i> Selected: ${methodData.method}</h5>
                        <p class="mb-3"><strong>${methodData.n_features} features</strong> ready to export</p>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success btn-lg w-100" onclick="exportToDashboard()">
                                    <i class="fas fa-download"></i> Download CSV
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-primary btn-lg w-100" onclick="downloadNotebook()">
                                    <i class="fas fa-file-code"></i> Download Notebook
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="transparency-section mt-4">
                    <h4><i class="fas fa-microscope"></i> Method Transparency - ${methodData.method}</h4>
                    <p style="color: #64748b; margin-bottom: 20px;">Detailed iteration logs showing how features were selected with 5-fold cross-validation</p>
                    ${generateTransparencyView(methodData)}
                </div>
            `;
            document.getElementById('exportOptions').innerHTML = exportHtml;
        }
        
        function generateTransparencyView(methodData) {
            if (!methodData.cv_details || methodData.cv_details.length === 0) {
                return '<p class="text-muted">No detailed CV logs available for this method.</p>';
            }
            
            let html = '';
            methodData.cv_details.forEach((iteration, idx) => {
                const cvScores = iteration.cv_scores || [];
                const mean = iteration.mean_score || 0;
                const std = iteration.std_score || 0;
                const ci95 = 1.96 * std;
                
                const maxScore = Math.max(...cvScores);
                const minScore = Math.min(...cvScores);
                
                html += `
                    <div class="cv-iteration">
                        <div class="iteration-header">
                            <div class="iteration-title">
                                Iteration ${iteration.iteration || idx + 1}
                                ${iteration.feature_added ? `<span style="color: #10b981;"> + ${iteration.feature_added}</span>` : ''}
                                ${iteration.feature_removed ? `<span style="color: #ef4444;"> - ${iteration.feature_removed}</span>` : ''}
                            </div>
                            <div class="iteration-stats">
                                <div class="iteration-stat">
                                    <div class="label">Features</div>
                                    <div class="value">${iteration.n_features || 'â€”'}</div>
                                </div>
                                <div class="iteration-stat">
                                    <div class="label">Mean (Î¼)</div>
                                    <div class="value">${mean.toFixed(4)}</div>
                                </div>
                                <div class="iteration-stat">
                                    <div class="label">Std (Ïƒ)</div>
                                    <div class="value" style="color: ${std < 0.05 ? '#10b981' : '#f59e0b'};">${std.toFixed(4)}</div>
                                </div>
                                <div class="iteration-stat">
                                    <div class="label">CI95</div>
                                    <div class="value" style="font-size: 1rem;">Â±${ci95.toFixed(4)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <strong style="font-size: 0.85rem; color: #64748b;">5-FOLD SCORES:</strong>
                            <div class="fold-scores" style="grid-template-columns: repeat(5, 1fr);">
                                ${cvScores.map((score, i) => {
                                    const isHigh = score >= mean;
                                    const isLow = score < mean - std;
                                    return `<div class="fold-score ${isHigh ? 'high' : ''} ${isLow ? 'low' : ''}" title="Fold ${i+1}: ${score.toFixed(4)}">${score.toFixed(3)}</div>`;
                                }).join('')}
                            </div>
                            <p style="font-size: 0.85rem; color: #64748b; margin-top: 10px;">
                                <strong>Range:</strong> ${minScore.toFixed(4)} to ${maxScore.toFixed(4)} | 
                                <strong>Variance:</strong> ${(std * std).toFixed(6)} | 
                                <strong>Stability:</strong> ${std < 0.05 ? '<span style="color: #10b981;">âœ“ Excellent</span>' : std < 0.1 ? '<span style="color: #f59e0b;">âš  Moderate</span>' : '<span style="color: #ef4444;">âœ— Poor</span>'}
                            </p>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function exportToDashboard() {
            if (!selectedFeatures.length || !selectedMethod) {
                alert('Please select a method first');
                return;
            }

            showLoading('Preparing download...', []);
            fetch('/module6/download_selected_features', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    selected_features: selectedFeatures,
                    method_name: selectedMethod
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Download failed');
                return response.blob();
            })
            .then(blob => {
                hideLoading();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${selectedMethod}_selected_features.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                alert(`Success! Downloaded ${selectedFeatures.length} features as CSV.`);
            })
            .catch(err => {
                hideLoading();
                alert('Error: ' + err.message);
            });
        }

        function downloadNotebook() {
            if (!selectedFeatures.length || !selectedMethod) {
                alert('Please select a method first');
                return;
            }

            showLoading('Generating notebook...', []);
            fetch('/module6/generate_notebook', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    method_name: selectedMethod,
                    selected_features: selectedFeatures
                })
            })
            .then(r => r.json())
            .then(data => {
                hideLoading();
                if (data.error) alert('Error: ' + data.error);
                else {
                    const blob = new Blob([JSON.stringify(data.notebook, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            })
            .catch(err => {
                hideLoading();
                alert('Error: ' + err.message);
            });
        }

        function updateProgress(stepIndex) {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, i) => {
                if (i < stepIndex) {
                    step.classList.remove('active');
                    step.classList.add('complete');
                } else if (i === stepIndex) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active', 'complete');
                }
            });
        }

        function showLoading(msg, steps) {
            document.getElementById('loadingMsg').textContent = msg;
            const stepsDiv = document.getElementById('progressSteps');
            stepsDiv.innerHTML = steps.map(s => `<div class="progress-step">${s}</div>`).join('');
            document.getElementById('loading').style.display = 'flex';
        }
        
        function updateLoadingProgress(methodIndex, totalMethods) {
            const progress = ((methodIndex + 1) / totalMethods) * 100;
            const fill = document.getElementById('progressFill');
            if (fill) {
                fill.style.width = progress + '%';
                fill.textContent = Math.round(progress) + '%';
            }
            updateProgress(methodIndex);
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
    <script src="{{ url_for('static', filename='js/gpt_explainer.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const observer = new MutationObserver(() => {
            document.querySelectorAll('.result-card, .card').forEach(card => {
                if (!card.querySelector('.explain-ai-btn')) {
                    const title = card.querySelector('h5, h4')?.textContent || 'Feature Engineering';
                    const cardBody = card.querySelector('.card-body');
                    if (cardBody && !title.includes('Select')) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-outline-primary explain-ai-btn mt-2';
                        btn.innerHTML = '<i class="fas fa-robot me-1"></i> Explain with AI';
                        btn.onclick = () => {
                            // Extract all text content including metrics
                            const fullText = card.textContent;
                            const results = {
                                operation: title,
                                details: fullText,
                                metrics: Array.from(card.querySelectorAll('.metric, .stat, strong')).map(el => el.textContent).join(', ')
                            };
                            explainFeatureResults(title, results);
                        };
                        cardBody.appendChild(btn);
                    }
                }
            });
        });
        observer.observe(document.body, {childList: true, subtree: true});
    });
    </script>
</body>
</html>

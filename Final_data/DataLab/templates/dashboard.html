{% extends "base.html" %}

{% block title %}Dashboard - DataLab{% endblock %}

{% block head %}
<!-- Custom CSS with cache busting -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=20251024230000">
<!-- Add AI assistant CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai_assistant.css') }}?v=20251024230000">
{% endblock %}

{% block content %}
<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="DataLab" height="45" style="filter: brightness(0) invert(1);">
      <div style="margin-top: 10px;">
        <span style="display: inline-block; font-size: 0.7rem; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);">v1.0.0 Prototype</span>
      </div>
    </div>
    <ul class="nav-menu">
      <li class="nav-item active">
        <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      </li>
      <li class="nav-item">
        <a href="#"><i class="fas fa-table"></i> Data Explorer</a>
      </li>
      <li class="nav-item">
        <a href="#" id="visualizationsNavLink"><i class="fas fa-chart-bar"></i> Visualizations</a>
      </li>
      <li class="nav-item">
        <a href="#"><i class="fas fa-cogs"></i> Data Processing</a>
      </li>
      <li class="nav-item">
        <a href="/ml"><i class="fas fa-brain"></i> ML Model Selection</a>
      </li>
      <li class="nav-item">
        <a href="/module6"><i class="fas fa-magic"></i> Feature Engineering</a>
      </li>
      <li class="nav-item">
        <a href="/ml/jupyterlite" target="_blank"><i class="fas fa-code"></i> Python Notebook</a>
      </li>
      <li class="nav-item">
        <a href="/workflow"><i class="fas fa-tools"></i> Open Mode Workflow</a>
      </li>
      <li class="nav-item">
        <a href="/pycaret-pipeline"><i class="fas fa-robot"></i> End-to-End Pipeline</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('ai_assistant_page') }}"><i class="fas fa-comments"></i> AI Assistant</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('community') }}"><i class="fas fa-users"></i> Community</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <div class="header-title">
        <h1>Welcome, {{ username }}</h1>
        <p>Here's an overview of your data</p>
      </div>
      <div class="theme-selector">
        <label for="theme">Theme</label>
        <select id="theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>

    <div class="dashboard-content">
      <!-- Prototype Limitations Notice -->
      <div class="alert prototype-limitations" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-left: 4px solid #F59E0B; border-radius: 12px; padding: 16px 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
        <div class="d-flex align-items-start">
          <div style="flex-shrink: 0; margin-right: 12px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 24px; height: 24px;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <div style="flex-grow: 1;">
            <h6 style="margin: 0 0 8px 0; color: #92400E; font-weight: 600; font-size: 0.95rem;">
              <i class="fas fa-flask me-2"></i>Prototype Version (v1.0.0)
            </h6>
            <p style="margin: 0 0 10px 0; color: #92400E; font-size: 0.85rem; line-height: 1.5;">
              DataLab is currently in prototype phase for educational and demonstration purposes. Some features may have limitations.
            </p>
            <button class="btn btn-sm" style="background: white; color: #92400E; border: 1px solid #F59E0B; font-size: 0.8rem; padding: 4px 12px; font-weight: 600;" type="button" data-bs-toggle="collapse" data-bs-target="#limitationsDetails" aria-expanded="false">
              <i class="fas fa-info-circle me-1"></i>View Limitations
            </button>
            <div class="collapse mt-3" id="limitationsDetails">
              <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="limitation-item" style="padding: 10px; border-left: 3px solid #F59E0B;">
                      <h6 style="font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 4px;">
                        <i class="fas fa-tachometer-alt me-2" style="color: #F59E0B;"></i>Performance
                      </h6>
                      <p style="font-size: 0.8rem; color: #6B7280; margin: 0;">Large datasets (>1000 rows) are sampled for faster analysis</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="limitation-item" style="padding: 10px; border-left: 3px solid #F59E0B;">
                      <h6 style="font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 4px;">
                        <i class="fas fa-shield-alt me-2" style="color: #F59E0B;"></i>Security
                      </h6>
                      <p style="font-size: 0.8rem; color: #6B7280; margin: 0;">Not recommended for production or sensitive data</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="limitation-item" style="padding: 10px; border-left: 3px solid #F59E0B;">
                      <h6 style="font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 4px;">
                        <i class="fas fa-plug me-2" style="color: #F59E0B;"></i>API Dependencies
                      </h6>
                      <p style="font-size: 0.8rem; color: #6B7280; margin: 0;">Some features require external API keys (OpenAI, Mistral)</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="limitation-item" style="padding: 10px; border-left: 3px solid #F59E0B;">
                      <h6 style="font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 4px;">
                        <i class="fas fa-file-csv me-2" style="color: #F59E0B;"></i>Data Formats
                      </h6>
                      <p style="font-size: 0.8rem; color: #6B7280; margin: 0;">Primarily designed for CSV/structured tabular data</p>
                    </div>
                  </div>
                </div>
                <div class="best-use-case" style="margin-top: 12px; padding: 10px; background: #ECFDF5; border-radius: 6px; border-left: 3px solid #10B981;">
                  <p style="font-size: 0.8rem; color: #065F46; margin: 0;">
                    <i class="fas fa-check-circle me-2" style="color: #10B981;"></i>
                    <strong>Best for:</strong> Educational purposes, proof-of-concept demos, and learning data science workflows
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- File Upload Section -->
      <div class="upload-section" id="uploadArea">
        <h3>Upload a new dataset</h3>
        <div class="file-upload">
          <button class="file-upload-btn">
            <i class="fas fa-cloud-upload-alt"></i> Choose File
          </button>
          <input type="file" class="file-upload-input" id="fileInput">
        </div>
        <p class="supported-formats">Supported formats: CSV, JSON, Excel, Text</p>
        <div id="uploadProgress" class="progress d-none mt-3">
          <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"
               aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <div id="uploadMessage" class="alert mt-3 d-none"></div>
      </div>



      <!-- Data Preview Section -->
      <div class="data-preview">
        <div class="section-header">
          <h3>My Datasets</h3>
          <div class="section-controls">
            <input type="text" id="datasetSearch" placeholder="Search datasets..." class="form-control form-control-sm">
          </div>
        </div>

        {% if datasets|length > 0 %}
        <div class="row" id="datasetsContainer">
          {% for dataset in datasets %}
          <div class="col-md-6 col-lg-4 mb-4 dataset-item">
            <div class="card dataset-card h-100" data-id="{{ dataset.id }}" data-name="{{ dataset.name }}" data-quality-components='{{ dataset.quality_components|tojson if dataset.quality_components else "{}" }}'>
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-truncate" title="{{ dataset.name }}">
                  {% if dataset.file_type == 'csv' %}
                    <i class="fas fa-file-csv text-success me-2"></i>
                  {% elif dataset.file_type == 'json' %}
                    <i class="fas fa-file-code text-warning me-2"></i>
                  {% elif dataset.file_type in ['xlsx', 'xls'] %}
                    <i class="fas fa-file-excel text-primary me-2"></i>
                  {% else %}
                    <i class="fas fa-file-alt text-secondary me-2"></i>
                  {% endif %}
                  {{ dataset.name }}
                </h6>
                <div class="dropdown">
                  <button class="btn btn-sm btn-light dataset-actions-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Dataset actions">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <!-- In the dropdown menu for each dataset card -->
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item text-danger delete-dataset" href="#" data-id="{{ dataset.id }}" data-name="{{ dataset.name }}"><i class="fas fa-trash-alt me-2"></i>Remove Dataset</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('data_preview', dataset_id=dataset.id) }}"><i class="fas fa-eye me-2"></i>Preview</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('data_quality', dataset_id=dataset.id) }}"><i class="fas fa-check-circle me-2"></i>Quality</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('summary_statistics', dataset_id=dataset.id) }}"><i class="fas fa-chart-pie me-2"></i>Statistics</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('visualization', dataset_id=dataset.id) }}"><i class="fas fa-chart-bar me-2"></i>Visualize</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('preprocessing_page', dataset_id=dataset.id) }}"><i class="fas fa-cogs me-2"></i>Preprocess</a></li>
                    <li><a class="dropdown-item" href="/ml/{{ dataset.id }}"><i class="fas fa-brain me-2"></i>ML Selection</a></li>
                    <li><a class="dropdown-item" href="/workflow/{{ dataset.id }}"><i class="fas fa-project-diagram me-2"></i>Workflow</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item clean-dataset" href="#" data-id="{{ dataset.id }}" data-name="{{ dataset.name }}"><i class="fas fa-broom me-2 text-info"></i>Clean Dataset</a></li>
                    <li><a class="dropdown-item analyze-with-ai" href="#" data-id="{{ dataset.id }}" data-name="{{ dataset.name }}"><i class="fas fa-robot me-2"></i>Analyze with AI</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span>
                      Quality Score
                      <i class="fas fa-info-circle quality-score-info" 
                         data-bs-toggle="modal" 
                         data-bs-target="#qualityScoreModal"
                         data-dataset-id="{{ dataset.id }}"
                         data-quality-score="{{ dataset.quality_score }}"
                         data-quality-components='{{ dataset.quality_components|tojson if dataset.quality_components else "{}" }}'
                         style="cursor: pointer;"></i>
                    </span>
                    <span class="fw-bold quality-score-value">{{ dataset.quality_score }}%</span>
                  </div>
                  {% if dataset.quality_components %}
                  <div class="text-muted small mt-1">
                    <div>Missing: {{ dataset.quality_components.missing_values.count if dataset.quality_components.missing_values else 0 }}</div>
                    <div>Duplicates: {{ dataset.quality_components.duplicate_rows.count if dataset.quality_components.duplicate_rows else 0 }}</div>
                    <div>Outliers: {{ dataset.quality_components.outliers.count if dataset.quality_components.outliers else 0 }}</div>
                  </div>
                  {% endif %}
                  <div class="quality-indicator">
                    <div class="quality-bar" style="width: {{ dataset.quality_score }}%;
                      background-color:
                        {% if dataset.quality_score >= 80 %}#28a745
                        {% elif dataset.quality_score >= 60 %}#ffc107
                        {% else %}#dc3545
                        {% endif %};">
                    </div>
                  </div>
                </div>
                <div class="row g-3 text-muted">
                  <div class="col-6">
                    <div><i class="fas fa-table me-1"></i> Rows</div>
                    <div class="fw-bold">{{ dataset.rows }}</div>
                  </div>
                  <div class="col-6">
                    <div><i class="fas fa-columns me-1"></i> Columns</div>
                    <div class="fw-bold">{{ dataset.columns }}</div>
                  </div>
                  <div class="col-12">
                    <div><i class="fas fa-calendar-alt me-1"></i> Created</div>
                    <div class="fw-bold">{{ dataset.created_at }}</div>
                  </div>
                </div>
                {% if dataset.ai_insights %}
                <div class="mt-3">
                  <div class="ai-insights-preview">
                    <div><i class="fas fa-robot me-1 text-primary"></i> AI Insights</div>
                    <div class="text-muted small">{{ dataset.ai_insights|truncate(100) }}</div>
                    <button class="btn btn-sm btn-outline-primary mt-2 view-ai-insights" data-id="{{ dataset.id }}">
                      View Full Insights
                    </button>
                  </div>
                </div>
                {% endif %}
              </div>
              <div class="card-footer bg-transparent">
                <div class="d-grid gap-2">
                  <a href="{{ url_for('visualization', dataset_id=dataset.id) }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-chart-bar me-1"></i>Visualize
                  </a>
                  <button class="btn btn-info btn-sm clean-dataset" data-id="{{ dataset.id }}" data-name="{{ dataset.name }}">
                    <i class="fas fa-broom me-1"></i>Clean Dataset
                  </button>
                  <a href="{{ url_for('data_preview', dataset_id=dataset.id) }}" class="btn btn-outline-secondary btn-sm">Analyze</a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-database fa-4x text-muted mb-3"></i>
          <h4>No datasets yet</h4>
          <p class="text-muted">Upload your first dataset to get started</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Quality Score Information Modal -->
<div class="modal fade" id="qualityScoreModal" tabindex="-1" aria-labelledby="qualityScoreModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="qualityScoreModalLabel">
          <i class="fas fa-calculator me-2"></i>Quality Score Breakdown
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Transparent Calculation:</strong> Quality Score = 100 - (Missing Penalty + Duplicate Penalty + Outlier Penalty)
        </div>

        <div id="qualityScoreBreakdown">
          <!-- Dynamic content will be inserted here -->
        </div>

        <hr>

        <h6 class="mb-3"><i class="fas fa-book me-2"></i>ISO 25012 Data Quality Dimensions</h6>
        
        <div class="quality-metric mb-2">
          <h6><i class="fas fa-check-circle text-success me-2"></i>1. Completeness (30%)</h6>
          <p class="text-muted small mb-0">Degree to which data is not missing</p>
        </div>

        <div class="quality-metric mb-2">
          <h6><i class="fas fa-fingerprint text-primary me-2"></i>2. Uniqueness (20%)</h6>
          <p class="text-muted small mb-0">Degree to which data is free from duplicates</p>
        </div>

        <div class="quality-metric mb-2">
          <h6><i class="fas fa-balance-scale text-info me-2"></i>3. Consistency (20%)</h6>
          <p class="text-muted small mb-0">Degree to which data follows patterns</p>
        </div>

        <div class="quality-metric mb-2">
          <h6><i class="fas fa-shield-alt text-warning me-2"></i>4. Validity (15%)</h6>
          <p class="text-muted small mb-0">Degree to which data conforms to formats</p>
        </div>

        <div class="quality-metric mb-2">
          <h6><i class="fas fa-bullseye text-danger me-2"></i>5. Accuracy (15%)</h6>
          <p class="text-muted small mb-0">Degree to which data represents reality</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Dataset Confirmation Modal -->
<div class="modal fade" id="deleteDatasetModal" tabindex="-1" aria-labelledby="deleteDatasetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDatasetModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong id="deleteDatasetName">this dataset</strong>? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Insights Modal -->
<div class="modal fade" id="aiInsightsModal" tabindex="-1" aria-labelledby="aiInsightsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiInsightsModalLabel">AI Insights</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="aiInsightsContent" class="ai-insights-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="askMoreAI">Ask AI More</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Assistant Button and Panel -->
<div id="aiAssistantButton" class="ai-assistant-button">
  <i class="fas fa-robot"></i>
</div>

<div id="aiAssistantPanel" class="ai-assistant-panel">
  <div class="assistant-header">
    <h3><i class="fas fa-robot"></i> AI Assistant</h3>
    <button id="closeAssistant" class="close-btn">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="assistantChatHistory" class="assistant-chat-history">
    <!-- Chat messages will be added here by JavaScript -->
  </div>
  <div id="assistantLoading" class="assistant-loading d-none">
    <div class="spinner"></div>
  </div>
  <div class="assistant-input">
    <textarea id="assistantMessage" placeholder="Ask about your data..."></textarea>
    <button id="sendAssistantMessage">
      <i class="fas fa-paper-plane"></i>
    </button>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js', v=20251201) }}"></script>
<script src="{{ url_for('static', filename='js/intelligent_display.js') }}"></script>
<!-- Add AI assistant JavaScript -->
<script src="{{ url_for('static', filename='js/ai_assistant.js') }}"></script>
<script>
  // Quality Score Modal Handler
  document.addEventListener('DOMContentLoaded', function() {
    // Handle quality score info clicks
    document.querySelectorAll('.quality-score-info').forEach(icon => {
      icon.addEventListener('click', function() {
        const qualityScore = parseFloat(this.getAttribute('data-quality-score'));
        const componentsData = this.getAttribute('data-quality-components');
        
        let components = {};
        try {
          components = JSON.parse(componentsData || '{}');
        } catch(e) {
          console.error('Error parsing quality components:', e);
        }
        
        const breakdownDiv = document.getElementById('qualityScoreBreakdown');
        
        if (components && Object.keys(components).length > 0) {
          // Show actual calculation
          let html = `
            <div class="card mb-3">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>Final Quality Score: ${qualityScore.toFixed(1)}%</h6>
              </div>
              <div class="card-body">
                <div class="progress mb-2" style="height: 30px;">
                  <div class="progress-bar ${qualityScore >= 80 ? 'bg-success' : qualityScore >= 60 ? 'bg-warning' : 'bg-danger'}" 
                       style="width: ${qualityScore}%;" role="progressbar">
                    ${qualityScore.toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>
            
            <h6 class="mb-3"><i class="fas fa-calculator me-2"></i>Detailed Calculation</h6>
          `;
          
          // Completeness
          if (components.completeness) {
            const comp = components.completeness;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-check-circle text-success me-2"></i>Completeness</h6>
                  <p class="mb-1">Score: <strong>${comp.score}%</strong> | Weight: <strong>${(comp.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-muted small">Missing: ${comp.missing_count} (${comp.missing_percentage}%)</p>
                </div>
              </div>
            `;
          } else if (components.missing_values) {
            const mv = components.missing_values;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-exclamation-triangle text-danger me-2"></i>Missing Values</h6>
                  <p class="mb-1">Count: <strong>${mv.count}</strong> (${mv.percentage.toFixed(2)}% of data)</p>
                  <p class="mb-1">Weight: <strong>${(mv.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-danger">Penalty: <strong>-${mv.penalty.toFixed(2)} points</strong></p>
                </div>
              </div>
            `;
          }
          
          
          // Uniqueness
          if (components.uniqueness) {
            const uniq = components.uniqueness;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-fingerprint text-primary me-2"></i>Uniqueness</h6>
                  <p class="mb-1">Score: <strong>${uniq.score}%</strong> | Weight: <strong>${(uniq.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-muted small">Duplicates: ${uniq.duplicate_count} (${uniq.duplicate_percentage}%)</p>
                </div>
              </div>
            `;
          } else if (components.duplicate_rows) {
            const dr = components.duplicate_rows;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-clone text-warning me-2"></i>Duplicate Rows</h6>
                  <p class="mb-1">Count: <strong>${dr.count}</strong> (${dr.percentage.toFixed(2)}% of rows)</p>
                  <p class="mb-1">Weight: <strong>${(dr.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-warning">Penalty: <strong>-${dr.penalty.toFixed(2)} points</strong></p>
                </div>
              </div>
            `;
          }
          
          
          // Consistency
          if (components.consistency) {
            const cons = components.consistency;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-balance-scale text-info me-2"></i>Consistency</h6>
                  <p class="mb-1">Score: <strong>${cons.score}%</strong> | Weight: <strong>${(cons.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-muted small">Outliers: ${cons.outlier_count} | Infinite: ${cons.infinite_count}</p>
                </div>
              </div>
            `;
          } else if (components.outliers) {
            const ol = components.outliers;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-chart-line text-info me-2"></i>Outliers</h6>
                  <p class="mb-1">Count: <strong>${ol.count}</strong> (${ol.percentage.toFixed(2)}%)</p>
                  <p class="mb-1">Weight: <strong>${(ol.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-info">Penalty: <strong>-${ol.penalty.toFixed(2)} points</strong></p>
                </div>
              </div>
            `;
          }
          
          
          // Validity
          if (components.validity) {
            const val = components.validity;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-shield-alt text-warning me-2"></i>Validity</h6>
                  <p class="mb-1">Score: <strong>${val.score}%</strong> | Weight: <strong>${(val.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-muted small">Empty strings: ${val.empty_strings} | Type mismatches: ${val.dtype_mismatches}</p>
                </div>
              </div>
            `;
          } else if (components.dtype_issues) {
            const dt = components.dtype_issues;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-code text-primary me-2"></i>Data Type Issues</h6>
                  <p class="mb-1">Count: <strong>${dt.count}</strong> (${dt.percentage.toFixed(2)}%)</p>
                  <p class="mb-1">Weight: <strong>${(dt.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-primary">Penalty: <strong>-${dt.penalty.toFixed(2)} points</strong></p>
                </div>
              </div>
            `;
          }
          
          
          // Accuracy
          if (components.accuracy) {
            const acc = components.accuracy;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-bullseye text-danger me-2"></i>Accuracy</h6>
                  <p class="mb-1">Score: <strong>${acc.score}%</strong> | Weight: <strong>${(acc.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-muted small">Extreme values: ${acc.extreme_values}</p>
                </div>
              </div>
            `;
          } else if (components.infinite_values) {
            const inf = components.infinite_values;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-infinity text-secondary me-2"></i>Infinite Values</h6>
                  <p class="mb-1">Count: <strong>${inf.count}</strong> (${inf.percentage.toFixed(2)}%)</p>
                  <p class="mb-1">Weight: <strong>${(inf.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-secondary">Penalty: <strong>-${inf.penalty.toFixed(2)} points</strong></p>
                </div>
              </div>
            `;
          }
          
          // Empty Strings
          if (components.empty_strings) {
            const es = components.empty_strings;
            html += `
              <div class="card mb-2">
                <div class="card-body">
                  <h6><i class="fas fa-font text-muted me-2"></i>Empty Strings</h6>
                  <p class="mb-1">Count: <strong>${es.count}</strong> (${es.percentage.toFixed(2)}%)</p>
                  <p class="mb-1">Weight: <strong>${(es.weight * 100).toFixed(0)}%</strong></p>
                  <p class="mb-0 text-muted">Penalty: <strong>-${es.penalty.toFixed(2)} points</strong></p>
                </div>
              </div>
            `;
          }
          
          // Calculation Summary
          const totalPenalty = (components.missing_values?.penalty || 0) + 
                               (components.duplicate_rows?.penalty || 0) + 
                               (components.outliers?.penalty || 0) +
                               (components.dtype_issues?.penalty || 0) +
                               (components.infinite_values?.penalty || 0) +
                               (components.empty_strings?.penalty || 0);
          
          html += `
            <div class="alert alert-primary mt-3">
              <h6><i class="fas fa-equals me-2"></i>Calculation</h6>
              <p class="mb-1">Starting Score: <strong>100</strong></p>
              <p class="mb-1">Total Penalties: <strong>-${totalPenalty.toFixed(2)}</strong></p>
              <hr>
              <p class="mb-0">Final Score: <strong>${qualityScore.toFixed(1)}%</strong></p>
            </div>
          `;
          
          breakdownDiv.innerHTML = html;
        } else {
          breakdownDiv.innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-info-circle me-2"></i>
              Detailed quality components not available for this dataset.
            </div>
          `;
        }
      });
    });
  });
  
  // AI Insights handler
  document.addEventListener('DOMContentLoaded', function() {
    // Handle view AI insights buttons
    const viewInsightsButtons = document.querySelectorAll('.view-ai-insights');
    const aiInsightsModal = document.getElementById('aiInsightsModal');
    const aiInsightsContent = document.getElementById('aiInsightsContent');
    const askMoreAIButton = document.getElementById('askMoreAI');

    viewInsightsButtons.forEach(button => {
      button.addEventListener('click', function() {
        const datasetId = this.getAttribute('data-id');
        const datasetCard = document.querySelector(`.dataset-card[data-id="${datasetId}"]`);
        const datasetName = datasetCard.querySelector('.card-header h6').textContent.trim();

        // Find AI insights from the page
        const aiInsightsPreview = this.closest('.ai-insights-preview');
        const aiInsightsText = aiInsightsPreview.querySelector('.text-muted').textContent;

        // Update modal content
        document.getElementById('aiInsightsModalLabel').textContent = `AI Insights for ${datasetName}`;

        // Format insights with proper paragraphs and highlighting
        let formattedInsights = aiInsightsText
          .replace(/\n\n/g, '</p><p>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>');

        aiInsightsContent.innerHTML = `<p>${formattedInsights}</p>`;

        // Set dataset ID for Ask More button
        askMoreAIButton.setAttribute('data-id', datasetId);
        askMoreAIButton.setAttribute('data-name', datasetName);

        // Show modal
        const modal = new bootstrap.Modal(aiInsightsModal);
        modal.show();
      });
    });

    // Handle "Ask AI More" button
    if (askMoreAIButton) {
      askMoreAIButton.addEventListener('click', function() {
        const datasetId = this.getAttribute('data-id');
        const datasetName = this.getAttribute('data-name');

        // Close modal
        const modal = bootstrap.Modal.getInstance(aiInsightsModal);
        if (modal) modal.hide();

        // Open AI assistant with prompt
        askAIAboutDataset(datasetId, datasetName, 'Tell me more about the dataset "{dataset}" and what preprocessing steps would you recommend?');
      });
    }
  });
</script>
{% endblock %}
